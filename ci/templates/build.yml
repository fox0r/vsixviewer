parameters:
  stageName: ''
  jobName: ''
  pool: ''
  env: ''

stages:
- stage: ${{ parameters.stageName }}
  jobs:
  - job: ${{ parameters.jobName }}
    pool: ${{ parameters.pool }}
    continueOnError: true
    steps:
    - task: NodeTool@0
      displayName: 'install nodejs'
      inputs:
        versionSpec: 10.x

    - task: Npm@1
      displayName: 'install dependencies'
      inputs:
        command: ci
        workingDir: '$(system.defaultworkingdirectory)'
        verbose: false

    - task: Npm@1
      displayName: 'validate we can create vsix'
      inputs:
        command: custom
        workingDir: '$(system.defaultworkingdirectory)'
        verbose: false
        customCommand: 'run package'

    - task: CopyFiles@2
      displayName: 'copy sources'
      inputs:
        SourceFolder: '$(system.defaultworkingdirectory)'
        Contents: |
            **/*
            !**/*.vsix
            !node_modules/**
            !out/**
            !.git/**
            !dist/**
            !.vscode/**
        TargetFolder: '$(Build.ArtifactStagingDirectory)/source'

    - publish: '$(Build.ArtifactStagingDirectory)/source'
      displayName: 'publish source'
      artifact: 'source'

    - task: CopyFiles@2
      displayName: 'copy vsix'
      inputs:
        SourceFolder: '$(system.defaultworkingdirectory)'
        Contents: '**/*.vsix'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/vsix'
      enabled: false

    - publish: '$(Build.ArtifactStagingDirectory)/vsix'
      displayName: 'publish vsix'
      artifact: 'vsix'
      
